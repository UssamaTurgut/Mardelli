@page "/media"
@using System.Globalization
@using MardelliWeb.Core
@inject MediaService MediaService
@inject DictionaryService DictionaryService
@inject AuthenticationStateProvider AuthState
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>@(IsGerman ? "Medien hochladen" : "Medya yükle")</PageTitle>

<div class="p-4">
    <h1>@(IsGerman ? "Medien hochladen" : "Medya yükle")</h1>
    <p class="text-muted">@(IsGerman ? "Laden Sie Video- oder Textmaterial hoch, in dem Mardelli vorkommt oder dokumentiert wird." : "Mardelli'nin geçtiği veya belgelendiği video veya metin yükleyin.")</p>
    <p class="text-muted">@(IsGerman ? "Ihr Upload erscheint unter Materialien, sobald ein Admin ihn freigegeben hat." : "Yüklemeniz bir admin onayladıktan sonra materyaller bölümünde görünecektir.")</p>

    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <p class="text-success">@SuccessMessage</p>
    }
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="text-danger">@ErrorMessage</p>
    }

    <form method="post" action="/api/media/upload" enctype="multipart/form-data" class="mb-4">
        <AntiforgeryToken />
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label" for="media-type">@(IsGerman ? "Typ" : "Tür")</label>
                <select name="Type" id="media-type" class="form-select">
                    <option value="Text">@(IsGerman ? "Text" : "Metin")</option>
                    <option value="Video">@(IsGerman ? "Video" : "Video")</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label" for="media-title">@(IsGerman ? "Titel" : "Başlık") *</label>
                <input type="text" name="Title" id="media-title" class="form-control" required placeholder="@(IsGerman ? "Titel eingeben" : "Başlık girin")" />
            </div>
            <div class="col-12">
                <label class="form-label" for="media-desc">@(IsGerman ? "Beschreibung (optional)" : "Açıklama (isteğe bağlı)")</label>
                <textarea name="Description" id="media-desc" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-md-6">
                <label class="form-label" for="media-file">@(IsGerman ? "Datei" : "Dosya")</label>
                <input type="file" name="File" id="media-file" class="form-control" accept=".txt,.md,.pdf" />
                <small class="text-muted">@(IsGerman ? "Text: .txt, .md, .pdf — Video: .mp4, .webm, .mov, …" : "Metin: .txt, .md, .pdf — Video: .mp4, .webm, .mov, …")</small>
            </div>
            <div class="col-md-6">
                <label class="form-label" for="media-region">@(IsGerman ? "Region (optional)" : "Bölge (isteğe bağlı)")</label>
                <select name="RegionId" id="media-region" class="form-select">
                    <option value="0">@(IsGerman ? "—" : "—")</option>
                    @foreach (var r in _regions)
                    {
                        <option value="@r.Id">@(IsGerman ? r.NameGerman : r.NameTurkish)</option>
                    }
                </select>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">@(IsGerman ? "Hochladen" : "Yükle")</button>
            </div>
        </div>
    </form>

    <script>
        (function() {
            var typeSelect = document.getElementById('media-type');
            var fileInput = document.getElementById('media-file');
            if (!typeSelect || !fileInput) return;
            function updateAccept() {
                fileInput.value = '';
                fileInput.accept = typeSelect.value === 'Video' ? 'video/*,.mp4,.webm,.mov,.avi,.mkv,.m4v' : '.txt,.md,.pdf';
            }
            typeSelect.addEventListener('change', updateAccept);
        })();
    </script>

    <h2 class="h5 mt-4">@(IsGerman ? "Ihre Einreichungen" : "Gönderileriniz")</h2>
    @if (_items.Any())
    {
        <ul class="list-group">
            @foreach (var m in _items)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        @m.Title (@(m.Type == MediaType.Video ? "Video" : "Text")) — @(m.Region != null ? (IsGerman ? m.Region.NameGerman : m.Region.NameTurkish) : "—")
                        @if (m.Status == EntryStatus.Pending)
                        { <span class="badge bg-warning text-dark ms-2">@(IsGerman ? "Ausstehend" : "Beklemede")</span> }
                        else if (m.Status == EntryStatus.Approved)
                        { <span class="badge bg-success ms-2">@(IsGerman ? "Freigegeben" : "Onaylandı")</span> }
                        else
                        { <span class="badge bg-secondary ms-2">@(IsGerman ? "Abgelehnt" : "Reddedildi")</span> }
                    </span>
                    @if (!string.IsNullOrEmpty(m.FilePath))
                    {
                        <a href="@m.FilePath" target="_blank" class="btn btn-sm btn-outline-primary">@(IsGerman ? "Öffnen" : "Aç")</a>
                    }
                </li>
            }
        </ul>
    }
    else
    {
        <p class="text-muted">@(IsGerman ? "Noch keine Materialien." : "Henüz materyal yok.")</p>
    }
</div>

@code {
    [SupplyParameterFromQuery(Name = "success")]
    public string? SuccessQuery { get; set; }
    [SupplyParameterFromQuery(Name = "error")]
    public string? ErrorQuery { get; set; }

    private List<MediaItem> _items = new();
    private List<Region> _regions = new();
    private bool IsGerman => CultureInfo.CurrentUICulture.TwoLetterISOLanguageName == "de";

    private string? SuccessMessage => SuccessQuery == "1" ? (IsGerman ? "Hochgeladen." : "Yüklendi.") : null;
    private string? ErrorMessage => string.IsNullOrEmpty(ErrorQuery) ? null : ErrorQuery;

    protected override async Task OnInitializedAsync()
    {
        _regions = await DictionaryService.GetRegionsAsync();
        var state = await AuthState.GetAuthenticationStateAsync();
        var userId = state.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        _items = await MediaService.GetItemsAsync(null, approvedOnly: false, createdByUserId: userId);
    }
}
