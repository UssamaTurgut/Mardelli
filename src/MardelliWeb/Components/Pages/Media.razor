@page "/media"
@using System.Globalization
@using MardelliWeb.Core
@inject MediaService MediaService
@inject DictionaryService DictionaryService
@inject AuthenticationStateProvider AuthState
@inject IJSRuntime JS
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>@(IsGerman ? "Medien hochladen" : "Medya yükle")</PageTitle>

<div class="p-4">
    <h1>@(IsGerman ? "Medien hochladen" : "Medya yükle")</h1>
    <p class="text-muted">@(IsGerman ? "Laden Sie Video- oder Textmaterial hoch, in dem Mardelli vorkommt oder dokumentiert wird." : "Mardelli'nin geçtiği veya belgelendiği video veya metin yükleyin.")</p>
    <p class="text-muted">@(IsGerman ? "Ihr Upload erscheint unter Materialien, sobald ein Admin ihn freigegeben hat." : "Yüklemeniz bir admin onayladıktan sonra materyaller bölümünde görünecektir.")</p>

    <EditForm Model="@_model" @ref="_editForm" class="mb-4">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">@(IsGerman ? "Typ" : "Tür")</label>
                <InputSelect @bind-Value="_model.Type" class="form-select">
                    <option value="@Core.MediaType.Video">@(IsGerman ? "Video" : "Video")</option>
                    <option value="@Core.MediaType.Text">@(IsGerman ? "Text" : "Metin")</option>
                </InputSelect>
            </div>
            <div class="col-md-6">
                <label class="form-label">@(IsGerman ? "Titel" : "Başlık")</label>
                <InputText @bind-Value="_model.Title" class="form-control" />
            </div>
            <div class="col-12">
                <label class="form-label">@(IsGerman ? "Beschreibung (optional)" : "Açıklama (isteğe bağlı)")</label>
                <InputTextArea @bind-Value="_model.Description" class="form-control" rows="2" />
            </div>
            <div class="col-md-6">
                <label class="form-label">@(IsGerman ? "Datei" : "Dosya")</label>
                <InputFile OnChange="OnFileSelected" class="form-control" accept="@(_model.Type == Core.MediaType.Video ? "video/*" : ".txt,.md")" />
            </div>
            <div class="col-md-6">
                <label class="form-label">@(IsGerman ? "Region (optional)" : "Bölge (isteğe bağlı)")</label>
                <InputSelect @bind-Value="_model.RegionId" class="form-select">
                    <option value="0">@(IsGerman ? "—" : "—")</option>
                    @foreach (var r in _regions)
                    {
                        <option value="@r.Id">@(IsGerman ? r.NameGerman : r.NameTurkish)</option>
                    }
                </InputSelect>
            </div>
            <div class="col-12">
                <button type="button" class="btn btn-primary" disabled="@_saving" @onclick="OnSubmitClick">@(IsGerman ? "Hochladen" : "Yükle")</button>
                @if (_success) { <span class="text-success ms-2">@(IsGerman ? "Hochgeladen." : "Yüklendi.")</span> }
            </div>
        </div>
    </EditForm>

    <h2 class="h5 mt-4">@(IsGerman ? "Ihre Einreichungen" : "Gönderileriniz")</h2>
    @if (_items.Any())
    {
        <ul class="list-group">
            @foreach (var m in _items)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        @m.Title (@(m.Type == Core.MediaType.Video ? "Video" : "Text")) — @(m.Region != null ? (IsGerman ? m.Region.NameGerman : m.Region.NameTurkish) : "—")
                        @if (m.Status == EntryStatus.Pending)
                        { <span class="badge bg-warning text-dark ms-2">@(IsGerman ? "Ausstehend" : "Beklemede")</span> }
                        else if (m.Status == EntryStatus.Approved)
                        { <span class="badge bg-success ms-2">@(IsGerman ? "Freigegeben" : "Onaylandı")</span> }
                        else
                        { <span class="badge bg-secondary ms-2">@(IsGerman ? "Abgelehnt" : "Reddedildi")</span> }
                    </span>
                    @if (!string.IsNullOrEmpty(m.FilePath))
                    {
                        <a href="@m.FilePath" target="_blank" class="btn btn-sm btn-outline-primary">@(IsGerman ? "Öffnen" : "Aç")</a>
                    }
                </li>
            }
        </ul>
    }
    else
    {
        <p class="text-muted">@(IsGerman ? "Noch keine Materialien." : "Henüz materyal yok.")</p>
    }
</div>

@code {
    private EditForm? _editForm;
    private List<MediaItem> _items = new();
    private List<Region> _regions = new();
    private MediaForm _model = new();
    private IBrowserFile? _selectedFile;
    private bool _saving;
    private bool _success;
    private bool IsGerman => CultureInfo.CurrentUICulture.TwoLetterISOLanguageName == "de";

    private async Task OnSubmitClick()
    {
        if (_editForm?.EditContext?.Validate() != true) return;
        await Submit();
    }

    protected override async Task OnInitializedAsync()
    {
        _regions = await DictionaryService.GetRegionsAsync();
        var state = await AuthState.GetAuthenticationStateAsync();
        var userId = state.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        _items = await MediaService.GetItemsAsync(null, approvedOnly: false, createdByUserId: userId);
    }

    private void OnFileSelected(InputFileChangeEventArgs e) => _selectedFile = e.File;

    private async Task Submit()
    {
        _saving = true;
        _success = false;
        StateHasChanged();
        try
        {
            var state = await AuthState.GetAuthenticationStateAsync();
            var userId = state.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId)) return;
            var item = new MediaItem
            {
                Type = _model.Type,
                Title = _model.Title?.Trim() ?? "",
                Description = string.IsNullOrWhiteSpace(_model.Description) ? null : _model.Description.Trim(),
                RegionId = _model.RegionId > 0 ? _model.RegionId : null
            };
            Stream? stream = null;
            string? fileName = null;
            if (_selectedFile != null)
            {
                stream = _selectedFile.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024); // 100 MB
                fileName = _selectedFile.Name;
            }
            await MediaService.AddAsync(item, userId, stream, fileName);
            if (stream != null) await stream.DisposeAsync();
            _success = true;
            _model = new MediaForm();
            _selectedFile = null;
            var state2 = await AuthState.GetAuthenticationStateAsync();
            var uid = state2.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            _items = await MediaService.GetItemsAsync(null, approvedOnly: false, createdByUserId: uid);
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }

    private class MediaForm
    {
        public Core.MediaType Type { get; set; }
        public string Title { get; set; } = "";
        public string? Description { get; set; }
        public int RegionId { get; set; }
    }
}
